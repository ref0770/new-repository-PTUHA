<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Matrix Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <style>
    .index-container{
        height: 100vh;
    }
    .sidebar {
        min-width: 250px;
    }
    .chat-area {
        flex-grow: 1;
    }
    .message-input {
        min-height: 80px;
    }
    .room-list li {
        transition: background-color 0.2s;
        list-style: none;
    }
    .room-list li:hover {
        background-color: #e0e7ff;
    }
    .room-list li.active {
        background-color: #bfdbfe;
        font-weight: 500;
    }
    .sidebar-list {
        height: 76vh;
        overflow-y: scroll;
    }
  </style>
</head>
<body class="index-container bg-gray-100 flex justify-center">
  <div x-data="chatApp()" :class="accessToken ? '' : 'items-center'" class="flex w-full">
    
    <!-- Сайдбар із кімнатами -->
    <template x-if="accessToken">
      <div class="sidebar p-4 bg-gray-50 border-r border-gray-200 overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">Кімнати</h2>
        <div class="room-list space-y-1 px-4">
          <ul class="sidebar-list">
            <template x-for="room in rooms" :key="room.roomId">
              <li class="flex items-center justify-between cursor-pointer rounded-lg p-2 hover:bg-indigo-50"
                  :class="{ 'bg-indigo-100 font-medium': room.roomId === roomId }"
                  @click="switchRoom(room.roomId)">
                <!-- Назва кімнати -->
                <span x-text="room.name || room.roomId" class="flex-1 truncate"></span>
                <!-- Кнопка видалення -->
                <button @click.stop="leaveRoom(room.roomId)"
                        class="ml-2 text-red-500 hover:text-red-700 text-xs font-medium">
                  × Видалити
                </button>
              </li>
            </template>
          </ul>
        </div>
        <div class="mt-4">
          <input x-model="newRoomName" placeholder="Назва нової кімнати" class="border p-2 w-full mb-2 rounded">
          <button @click="createRoom()" class="bg-indigo-500 text-white p-2 w-full rounded hover:bg-indigo-600 transition">
            Створити кімнату
          </button>
          <p x-show="newRoomId" class="text-sm text-gray-600 mt-1">
            ID кімнати: <span x-text="newRoomId"></span>
          </p>
        </div>
      </div>
    </template>
    
    <!-- Контейнер для основної області чату -->
    <div class="chat-area p-4 flex flex-col w-full">
      <!-- Форма логіну -->
      <template x-if="!accessToken">
        <div class="w-96 mx-auto">
          <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Вхід в систему</h2>
          <input x-model="username" placeholder="Ім'я користувача (наприклад, @user:matrix.org)"
                 class="border border-gray-300 p-3 w-full mb-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <input x-model="password" type="password" placeholder="Пароль"
                 class="border border-gray-300 p-3 w-full mb-4 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <button @click="login()" class="bg-blue-500 hover:bg-blue-600 text-white p-3 w-full rounded-lg transition duration-200 font-medium">
            Увійти
          </button>
          <p x-text="error" class="text-red-500 mt-3 text-center"></p>
        </div>
      </template>

      <!-- Чат після авторизації -->
      <template x-if="accessToken">
        <div class="flex flex-col h-full">
          <!-- User ID та Room ID -->
          <div class="mb-2 p-2 bg-gray-200 rounded text-sm break-words flex justify-between">
            <div>
              <span class="font-bold">Ваш Matrix ID:</span>
              <span x-text="userId ? userId : 'Завантаження...'"></span>
            </div>
            <div class="text-right">
              <span class="font-bold">ID кімнати:</span>
              <span x-text="roomId || 'Не обрано'" class="ml-1 bg-gray-100 p-1 rounded"></span>
            </div>
          </div>
          
          <!-- Список повідомлень -->
          <div class="flex-1 overflow-y-auto mb-4 p-2 bg-gray-50 rounded border border-gray-200 h-[400px]">
            <template x-if="messages.length === 0">
              <p class="text-gray-500 text-center">Повідомлень ще немає. Почніть розмову!</p>
            </template>
            <template x-for="msg in messages" :key="msg.id">
              <div class="mb-2">
                <strong x-text="msg.sender === userId ? 'Ви' : msg.sender.split(':')[0].substring(1) + ':'"></strong>
                <span x-text="msg.body" class="ml-2"></span>
              </div>
            </template>
          </div>
          
          <!-- Поле для введення повідомлення -->
          <div class="mb-4">
            <textarea x-model="newMessage" placeholder="Введіть ваше повідомлення..." 
                      class="message-input border p-2 w-full mb-2 rounded resize-y focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <button @click="sendMessage()" class="bg-green-500 text-white p-2 w-full rounded hover:bg-green-600 transition">
              Надіслати
            </button>
          </div>
        </div>
      </template>
    </div>

    <!-- Сайдбар із користувачами -->
    <template x-if="accessToken">
      <div class="sidebar p-4 bg-gray-50 border-r border-gray-200 overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">Користувачі</h2>
        
        <!-- Список учасників -->
        <template x-if="accessToken && roomId">
          <div class="mt-6 p-4 bg-gray-100 rounded-lg">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Учасники кімнати</h3>
            <template x-if="roomMembers.length === 0">
              <p class="text-xs text-gray-500">Завантаження...</p>
            </template>
            <ul class="text-xs space-y-1">
              <template x-for="member in roomMembers" :key="member.userId">
                <li class="flex items-center justify-between">
                  <div>
                    <span class="font-medium" x-text="member.displayName"></span>
                    <span class="text-gray-500" x-text="'(' + member.userId.split(':')[0].substring(1) + ')'"></span>
                  </div>
                  <!-- Кнопка видалення юзера (kick) -->
                  <button
                    @click.stop="kickUser(member.userId)"
                    class="text-red-600 hover:text-red-800 text-xs font-bold ml-2"
                    title="Викинути з кімнати">
                    ×
                  </button>
                </li>
              </template>
            </ul>
          </div>
        </template>
        
        <!-- Запрошення та приєднання -->
        <div class="space-y-2 mt-4">
          <div>
            <input x-model="inviteUser" placeholder="Запросити користувача (наприклад, @user:matrix.org)" class="border p-2 w-full mb-1 rounded">
            <button @click="inviteUserToRoom()" class="bg-purple-500 text-white p-2 w-full rounded hover:bg-purple-600 transition">
              Запросити
            </button>
          </div>
          <div>
            <input x-model="joinRoomId" placeholder="ID кімнати для приєднання (наприклад, !roomId:matrix.org)" class="border p-2 w-full mb-1 rounded">
            <button @click="joinRoom()" class="bg-yellow-500 text-white p-2 w-full rounded hover:bg-yellow-600 transition">
              Приєднатися до кімнати
            </button>
          </div>
        </div>
      </div>
    </template>
  </div>

  <script>
    async function login() {
      try {
        this.error = 'Завантаження...';
        
        const res = await fetch('https://matrix.org/_matrix/client/r0/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            type: 'm.login.password', 
            user: this.username, 
            password: this.password 
          })
        });
        
        const data = await res.json();
        if (data.access_token) {
          this.accessToken = data.access_token;
          this.userId = data.user_id;
          this.error = '';
          await this.fetchRoomsWithNames();
          this.fetchMessages();
          
          setInterval(() => {
            this.fetchRoomsWithNames();
            this.fetchMessages();
          }, 5000);
        } else {
          this.error = 'Невірний логін або пароль: ' + (data.error || 'Невідома помилка');
        }
      } catch (e) {
        this.error = 'Помилка під час авторизації: ' + e.message;
        console.error(e);
      }
    }

    async function createRoom() {
      if (!this.newRoomName.trim()) return;
      try {
        const res = await fetch('https://matrix.org/_matrix/client/r0/createRoom', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.accessToken}`
          },
          body: JSON.stringify({ 
            preset: 'private_chat', 
            name: this.newRoomName.trim(), 
            invite: this.inviteUser ? [this.inviteUser.trim()] : [] 
          })
        });
        
        const data = await res.json();
        if (data.room_id) {
          this.newRoomId = data.room_id;
          this.roomId = data.room_id;
          this.messages = [];
          this.lastSyncToken = '';
          await this.fetchRoomsWithNames();
          this.fetchMessages();
          this.fetchRoomMembers();
          this.inviteUser = '';
          alert(`Кімнату "${this.newRoomName}" створено з ID: ${this.newRoomId}`);
        } else {
          console.error('Помилка створення кімнати:', data);
          alert('Помилка створення кімнати: ' + (data.error || 'Невідома помилка'));
        }
      } catch (e) {
        console.error('Помилка створення кімнати:', e);
        alert('Помилка створення кімнати: ' + e.message);
      }
    }

    async function fetchRoomsWithNames() {
      if (!this.accessToken) return;
      try {
        const res = await fetch('https://matrix.org/_matrix/client/r0/joined_rooms', {
          headers: { 'Authorization': `Bearer ${this.accessToken}` }
        });
        
        const data = await res.json();
        if (data.joined_rooms) {
          const roomPromises = data.joined_rooms.map(async (roomId) => {
            try {
              const nameRes = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(roomId)}/state/m.room.name`, {
                headers: { 'Authorization': `Bearer ${this.accessToken}` }
              });
              
              if (nameRes.ok) {
                const nameData = await nameRes.json();
                return {
                  roomId,
                  name: nameData?.name || this.getRoomName(roomId) || roomId
                };
              }
            } catch (e) {
              console.error('Error fetching room name:', e);
            }
            
            return {
              roomId,
              name: this.getRoomName(roomId) || roomId
            };
          });
          
          this.rooms = (await Promise.all(roomPromises))
            .sort((a, b) => a.roomId.localeCompare(b.roomId));
          
          if (this.rooms.length > 0 && !this.roomId) {
            this.roomId = this.rooms[0].roomId;
            this.fetchRoomMembers();
          }
        }
      } catch (e) {
        console.error('Помилка завантаження кімнат:', e);
      }
    }

    function getRoomName(roomId) {
      return roomId.split(':')[0].replace('!', '').slice(0, 10) + '...';
    }

    function switchRoom(roomId) {
      if (roomId) this.roomId = roomId;
      this.messages = [];
      this.lastSyncToken = '';
      this.fetchMessages();
      this.fetchRoomMembers();
    }

    async function inviteUserToRoom() {
      if (!this.inviteUser.trim() || !this.roomId) {
        console.warn('No inviteUser or roomId');
        return;
      }
      try {
        const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${this.roomId}/invite`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.accessToken}`
          },
          body: JSON.stringify({ user_id: this.inviteUser.trim() })
        });
        const data = await res.json();

        if (data.errcode) {
          console.error('Invite failed:', data);
          alert('Помилка запрошення: ' + (data.error || 'Невідома помилка'));
        } else {
          this.inviteUser = '';
          alert('Користувача запрошено до кімнати');
          await this.fetchRoomsWithNames();
          this.fetchRoomMembers();
        }
      } catch (e) {
        console.error('Помилка запрошення:', e);
        alert('Помилка запрошення: ' + e.message);
      }
    }

    async function joinRoom() {
      if (!this.joinRoomId.trim()) return;
      try {
        const res = await fetch(`https://matrix.org/_matrix/client/r0/join/${encodeURIComponent(this.joinRoomId.trim())}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${this.accessToken}`
          }
        });
        const data = await res.json();
        if (data.room_id) {
          this.roomId = this.joinRoomId.trim();
          this.joinRoomId = '';
          this.messages = [];
          this.lastSyncToken = '';
          await this.fetchRoomsWithNames();
          this.fetchMessages();
          this.fetchRoomMembers();
        } else {
          console.error('Помилка приєднання:', data);
          alert('Помилка приєднання: ' + (data.error || 'Невідома помилка'));
        }
      } catch (e) {
        console.error('Помилка приєднання до кімнати:', e);
        alert('Помилка приєднання до кімнати: ' + e.message);
      }
    }

    async function sendMessage() {
      if (!this.newMessage.trim() || !this.roomId) {
        console.warn('No message or roomId');
        return;
      }
      const msg = this.newMessage.trim();
      this.newMessage = '';
      try {
        const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${this.roomId}/send/m.room.message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.accessToken}`
          },
          body: JSON.stringify({ msgtype: 'm.text', body: msg })
        });
        const data = await res.json();
        if (data.event_id) {
          this.messages.push({ id: data.event_id, body: msg, sender: this.userId });
        } else {
          console.error('Помилка відправки:', data);
        }
      } catch (e) {
        console.error('Помилка відправки повідомлення:', e);
      }
    }

    async function fetchMessages() {
      if (!this.accessToken || !this.roomId) return;
      try {
        const url = this.lastSyncToken ?
          `https://matrix.org/_matrix/client/r0/sync?since=${this.lastSyncToken}&timeout=30000` :
          `https://matrix.org/_matrix/client/r0/sync?timeout=30000`;
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${this.accessToken}` }
        });
        const data = await res.json();
        if (data.next_batch) {
          this.lastSyncToken = data.next_batch;
          if (data.rooms?.join?.[this.roomId]) {
            const roomData = data.rooms.join[this.roomId];
            roomData.timeline?.events?.forEach(event => {
              if (event.type === 'm.room.message' && !this.messages.find(m => m.id === event.event_id)) {
                this.messages.push({
                  id: event.event_id,
                  body: event.content.body,
                  sender: event.sender
                });
              }
            });
          }
          if (data.rooms?.invite) {
            for (const [room] of Object.entries(data.rooms.invite)) {
              await this.joinRoom(room);
            }
          }
          await this.fetchRoomsWithNames();
        } else {
          console.warn('No next_batch in sync response:', data);
        }
      } catch (e) {
        console.error('Помилка завантаження повідомлень:', e);
      }
    }

    async function fetchRoomMembers() {
      if (!this.accessToken || !this.roomId) return;
      try {
        const res = await fetch(
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/joined_members`,
          {
            headers: { 'Authorization': `Bearer ${this.accessToken}` }
          }
        );
        const data = await res.json();
        this.roomMembers = Object.entries(data.joined || {}).map(([userId, info]) => ({
          userId,
          displayName: info.display_name || userId.split(':')[0].substring(1),
          avatarUrl: info.avatar_url
        }));
      } catch (e) {
        console.error('Error fetching room members:', e);
      }
    }

    async function leaveRoom(roomId) {
      if (!this.accessToken || !roomId) return;

      if (!confirm(`Ви впевнені, що хочете покинути (видалити) кімнату?`)) {
        return;
      }

      try {
        const res = await fetch(
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(roomId)}/leave`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${this.accessToken}`
            }
          }
        );

        const data = await res.json();

        if (res.ok) {
          // Успішно покинуто
          this.rooms = this.rooms.filter(r => r.roomId !== roomId);

          // Якщо була вибрана саме ця кімната — скидаємо
          if (this.roomId === roomId) {
            this.roomId = '';
            this.messages = [];
            this.roomMembers = [];
          }

          alert('Кімнату покинуто.');
          await this.fetchRoomsWithNames(); // Оновлюємо список
        } else {
          console.error('Leave failed:', data);
          alert('Не вдалося покинути кімнату: ' + (data.error || 'Невідома помилка'));
        }
      } catch (e) {
        console.error('Leave room error:', e);
        alert('Помилка: ' + e.message);
      }
    }

    async function kickUser(userId) {
      if (!this.accessToken || !this.roomId || !userId) return;

      if (!confirm(`Викинути користувача ${userId} з кімнати?`)) {
        return;
      }

      try {
        const res = await fetch(
          `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/kick`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.accessToken}`
            },
            body: JSON.stringify({ user_id: userId })
          }
        );

        const data = await res.json();

        if (res.ok) {
          // Успішно викинуто
          this.roomMembers = this.roomMembers.filter(m => m.userId !== userId);
          alert(`Користувач ${userId} викинутий з кімнати.`);
          await this.fetchRoomMembers(); // Оновлюємо список
        } else {
          console.error('Kick failed:', data);
          alert('Не вдалося викинути користувача: ' + (data.error || 'Невідома помилка'));
        }
      } catch (e) {
        console.error('Kick error:', e);
        alert('Помилка: ' + e.message);
      }
    }

    function chatApp() {
      return {
        username: '',
        password: '',
        accessToken: '',
        userId: '',
        roomId: '',
        joinRoomId: '',
        newRoomName: '',
        newRoomId: '',
        rooms: [],
        messages: [],
        newMessage: '',
        inviteUser: '',
        error: '',
        lastSyncToken: '',
        roomMembers: [],
        login,
        createRoom,
        fetchRoomsWithNames,
        joinRoom,
        inviteUserToRoom,
        getRoomName,
        switchRoom,
        sendMessage,
        fetchMessages,
        fetchRoomMembers,
        leaveRoom, // ← Додаємо видалення кімнат
        kickUser,  // ← Додаємо вигнання користувачів
        logout() {
          this.accessToken = '';
          this.userId = '';
          this.username = '';
          this.password = '';
          this.rooms = [];
          this.messages = [];
          this.roomMembers = [];
        }
      }
    }
  </script>
</body>
</html>