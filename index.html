<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Matrix Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  
  <!-- Підключення стилів -->
  <link rel="stylesheet" href="./styles/main.css">
  <link rel="stylesheet" href="./login/login.css">
  <link rel="stylesheet" href="./sidebar/sidebar.css">
</head>
<body class="bg-gray-100 flex items-center justify-center p-4">
  <!-- Основний контейнер -->
  <div x-data="chatApp()" class="chat-container bg-white rounded-lg shadow-lg flex w-full max-w-5xl">
    <!-- Контейнер для сайдбару -->
    <div id="sidebar-container"></div>
    
    <!-- Контейнер для основної області чату -->
    <div class="chat-area p-4 flex flex-col w-full">
      <!-- Контейнер для логіну -->
      <div id="login-container"></div>
      
      <!-- Контейнер для повідомлень (буде показано після логіну) -->
      <template x-if="accessToken">
        <div class="flex-1 flex flex-col">
          <!-- Заголовок кімнати -->
          <div class="border-b border-gray-200 pb-2 mb-4">
            <h2 x-text="rooms.find(r => r.roomId === roomId)?.name || roomId" class="text-lg font-semibold"></h2>
          </div>
          
          <!-- Список повідомлень -->
          <div class="flex-1 overflow-y-auto mb-4 space-y-2">
            <template x-for="message in messages" :key="message.id">
              <div class="message p-2 rounded">
                <span class="font-semibold" x-text="message.sender"></span>:
                <span x-text="message.body"></span>
              </div>
            </template>
          </div>
          
          <!-- Поле для вводу повідомлення -->
          <div class="border-t border-gray-200 pt-4">
            <textarea 
              x-model="newMessage" 
              placeholder="Type your message..." 
              class="message-input border p-2 w-full rounded"
              @keydown.enter.prevent="sendMessage()"
            ></textarea>
            <button 
              @click="sendMessage()" 
              class="bg-green-500 text-white p-2 w-full rounded hover:bg-green-600 transition mt-2"
            >
              Send Message
            </button>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Підключення JavaScript файлів -->
  <script src="./login/login.js"></script>
  <script src="./sidebar/sidebar.js"></script>
  
  <script>
    // Додаткові функції для чату
    async function sendMessage() {
      if (!this.newMessage.trim() || !this.roomId || !this.accessToken) return;
      
      try {
        const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/send/m.room.message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.accessToken}`
          },
          body: JSON.stringify({
            msgtype: 'm.text',
            body: this.newMessage.trim()
          })
        });
        
        const data = await res.json();
        if (data.event_id) {
          this.newMessage = '';
          this.fetchMessages();
        }
      } catch (e) {
        console.error('Send message error:', e);
      }
    }

    async function fetchMessages() {
      if (!this.roomId || !this.accessToken) return;
      
      try {
        let url = `https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.roomId)}/messages?dir=b&limit=50`;
        if (this.lastSyncToken) {
          url += `&from=${this.lastSyncToken}`;
        }
        
        const res = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${this.accessToken}`
          }
        });
        
        const data = await res.json();
        if (data.chunk) {
          this.messages = data.chunk
            .filter(event => event.type === 'm.room.message')
            .map(event => ({
              id: event.event_id,
              sender: event.sender,
              body: event.content?.body || ''
            }));
          
          if (data.end) {
            this.lastSyncToken = data.end;
          }
        }
      } catch (e) {
        console.error('Fetch messages error:', e);
      }
    }

    function switchRoom(roomId) {
      this.roomId = roomId;
      this.messages = [];
      this.lastSyncToken = '';
      this.fetchMessages();
    }

    function getRoomName(roomId) {
      // Проста функція для отримання імені кімнати
      return roomId.split(':')[0].replace('!', '');
    }

    // Завантаження HTML-шаблонів
    document.addEventListener('DOMContentLoaded', () => {
      // Завантаження login.html
      fetch('./login/login.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('login-container').innerHTML = html;
        })
        .catch(error => console.error('Error loading login:', error));

      // Завантаження sidebar.html
      fetch('./sidebar/sidebar.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('sidebar-container').innerHTML = html;
        })
        .catch(error => console.error('Error loading sidebar:', error));
    });

    function chatApp() {
      return {
        username: '',
        password: '',
        accessToken: '',
        userId: '',
        roomId: '',
        joinRoomId: '',
        newRoomName: '',
        newRoomId: '',
        rooms: [],
        messages: [],
        newMessage: '',
        inviteUser: '',
        error: '',
        lastSyncToken: '',
        login,
        createRoom,
        fetchRoomsWithNames,
        sendMessage,
        fetchMessages,
        switchRoom,
        getRoomName
      }
    }
  </script>
</body>
</html>